"use strict";const t=require("../../common/vendor.js"),e={components:{FloatingNav:()=>"../../components/FloatingNav.js"},data:()=>({cart:[]}),computed:{total(){return this.cart.reduce(((t,e)=>t+e.price*(e.quantity||1)),0)},selectedTotal(){return this.cart.reduce(((t,e)=>t+(e.selected?e.price*(e.quantity||1):0)),0)},selectedCount(){return this.cart.filter((t=>t.selected)).length},isAllSelected(){return this.cart.length>0&&this.selectedCount===this.cart.length},selectedThumbs(){return this.cart.filter((t=>t.selected)).slice(0,2).map((t=>t.image||"/static/logo.png"))},officialReduce(){return this.cart.reduce(((t,e)=>t+(e.selected&&e.officialReduce||0)),0)},redReduce(){return this.cart.reduce(((t,e)=>t+(e.selected&&e.redReduce||0)),0)},extraReduce(){return this.cart.reduce(((t,e)=>t+(e.selected&&e.reduce||0)),0)},totalReduce(){return this.officialReduce+this.redReduce+this.extraReduce},payable(){return Math.max(0,this.selectedTotal-this.totalReduce)},needForCoupon(){return Math.max(0,800-this.payable).toFixed(2)},groups:function(){try{const t={};return(this.cart||[]).forEach((e=>{const c=e.roomName||"默认房间";t[c]||(t[c]=[]),t[c].push(e)})),Object.keys(t).map((e=>({name:e,items:t[e]})))}catch(t){return console.error("groups computed error",t),[]}}},onShow(){this.load()},methods:{load(){try{this.cart=t.index.getStorageSync("cart")||[]}catch(e){this.cart=[]}this.cart=(this.cart||[]).map((t=>({...t,quantity:t.quantity||1,selected:!!t.selected})))},sync(){t.index.setStorageSync("cart",this.cart)},findIndexById(t){return this.cart.findIndex((e=>e.id===t))},incById(t){const e=this.findIndexById(t);e>=0&&(this.cart[e].quantity+=1,this.sync())},decById(t){const e=this.findIndexById(t);e>=0&&(this.cart[e].quantity=Math.max(1,(this.cart[e].quantity||1)-1),this.sync())},removeById(t){const e=this.findIndexById(t);e>=0&&(this.cart.splice(e,1),this.sync())},removeSelected(){this.cart=this.cart.filter((t=>!t.selected)),this.sync()},toggleById(t){const e=this.findIndexById(t);e>=0&&(this.cart[e].selected=!this.cart[e].selected,this.sync())},toggleAll(){const t=!(this.selectedCount===this.cart.length&&this.cart.length>0);this.cart.forEach((e=>e.selected=t)),this.sync()},clear(){this.cart=[],this.sync()},checkout(){if(0===this.selectedCount)return void t.index.showToast({title:"请选择商品",icon:"none"});const e=this.cart.filter((t=>t.selected)),c={};e.forEach((t=>{const e=t.roomName||"默认房间";c[e]||(c[e]=[]),c[e].push({id:t.id,title:t.title,price:t.price,quantity:t.quantity,specTemp:t.specTemp||"",specLength:t.specLength||"",roomName:e})}));const r=Object.keys(c).map((t=>{const e=c[t],r=e.reduce(((t,e)=>t+e.price*e.quantity),0);return{name:t,items:e,roomTotal:r}})),i=new Date,s=Date.now(),a=`JD${i.getFullYear()}${String(i.getMonth()+1).padStart(2,"0")}${String(i.getDate()).padStart(2,"0")}${String(s).slice(-6)}`,o=`WB${Math.floor(1e10*Math.random()).toString().padStart(10,"0")}`,n=i.getTime(),d=[{time:new Date(n).toISOString(),status:"已下单",desc:"订单已提交，等待商家处理",place:"系统"},{time:new Date(n+3e5).toISOString(),status:"拣货中",desc:"商家正在为您拣货",place:"仓库"},{time:new Date(n+18e5).toISOString(),status:"已揽收",desc:"快递已揽收包裹",place:"揽收点"}],l={id:s,orderNo:a,waybillNo:o,createdAt:i.toISOString(),rooms:r,total:r.reduce(((t,e)=>t+e.roomTotal),0),tracking:d};try{const e=t.index.getStorageSync("orders")||[];t.index.setStorageSync("orders",[l,...e]),this.cart=this.cart.filter((t=>!t.selected)),this.sync(),this.exportExcel(l),t.index.showToast({title:"已生成订单",icon:"success"}),t.index.navigateTo({url:"/pages/order/index?id="+l.id})}catch(h){console.error(h)}},exportExcel(t){try{let e='<table border="1" cellspacing="0" cellpadding="4"><tr>'+["房间","商品","型号","色温","长度","单价","数量","金额"].map((t=>`<th>${t}</th>`)).join("")+"</tr>";t.rooms.forEach((t=>{t.items.forEach((c=>{const r=[t.name,c.title,c.id,c.specTemp||"",c.specLength||"",c.price.toFixed(2),c.quantity,(c.price*c.quantity).toFixed(2)];e+="<tr>"+r.map((t=>`<td>${t}</td>`)).join("")+"</tr>"}))})),e+="</table>";const c=new Blob([`\ufeff${e}`],{type:"application/vnd.ms-excel"}),r=URL.createObjectURL(c),i=document.createElement("a");i.href=r,i.download=`订单_${t.id}.xls`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}catch(e){}}}};const c=t._export_sfc(e,[["render",function(e,c,r,i,s,a){return t.e({a:s.cart.length},s.cart.length?{b:t.f(a.groups,((e,c,r)=>({a:t.t(e.name),b:t.f(e.items,((e,c,r)=>({a:e.selected?1:"",b:t.o((t=>a.toggleById(e.id)),e.id),c:e.image||"/static/logo.png",d:t.t(e.title),e:t.t(e.price.toFixed(2)),f:t.o((t=>a.decById(e.id)),e.id),g:t.t(e.quantity),h:t.o((t=>a.incById(e.id)),e.id),i:t.o((t=>a.removeById(e.id)),e.id),j:e.id}))),c:e.name})))}:{},{c:a.isAllSelected?1:"",d:t.o(((...t)=>a.toggleAll&&a.toggleAll(...t))),e:t.t(a.selectedTotal.toFixed(2)),f:t.o(((...t)=>a.clear&&a.clear(...t))),g:t.t(a.selectedCount),h:0===a.selectedCount,i:t.o(((...t)=>a.checkout&&a.checkout(...t)))})}],["__scopeId","data-v-8331f65c"]]);wx.createPage(c);

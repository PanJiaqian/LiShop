import{k as e,j as l,n as a,q as t,m as o,A as s,B as i,u as n,c,w as d,d as r,o as u,a as m,b as f,t as h,f as p,F as _,v as y,C as g,g as k,i as v,e as w,I as F,x as C}from"./index-D--6mQz1.js";import{F as b}from"./FloatingNav.BIlG4RBz.js";import{f as N,h as V,s as S,i as I,j as P}from"./index.XrWgwEH0.js";import{_ as E}from"./logo.rRFpfryy.js";import{_ as x}from"./_plugin-vue_export-helper.BCo6x5W8.js";const M=x({components:{FloatingNav:b},data:()=>({loggedIn:!1,displayName:"",fetchedProfile:{},isEditing:!1,editForm:{},showSecurityModal:!1,securityType:"",securityForm:{value:"",code:""},countdown:0,timer:null}),computed:{profile(){try{const l=this.fetchedProfile.user_id?this.fetchedProfile:e("user")||null;return{username:(null==l?void 0:l.username)||"未设置",phone:(null==l?void 0:l.phone)||"未设置",email:(null==l?void 0:l.email)||"未设置",companyName:(null==l?void 0:l.company_name)||(null==l?void 0:l.companyName)||"未设置",contactName:(null==l?void 0:l.contact_name)||(null==l?void 0:l.contactName)||"未设置",region:(null==l?void 0:l.region)||"未设置"}}catch(l){return{username:"未设置",phone:"未设置",email:"未设置",companyName:"未设置",contactName:"未设置",region:"未设置"}}},securityTitle(){return{phone:"更换手机号",email:"更换邮箱",password:"修改登录密码"}[this.securityType]||"安全验证"},securityPlaceholder(){return{phone:"请输入新手机号",email:"请输入新邮箱",password:"请输入新密码"}[this.securityType]||""}},onShow(){try{l({animation:!1})}catch(a){}try{const l=e("user")||null;if(this.loggedIn=!!l,this.displayName=(null==l?void 0:l.username)||"",this.loggedIn){const e=l&&(l.token||l.data&&l.data.token)||"";this.loadUserProfile(e)}}catch(a){}},methods:{loadUserProfile(e){e&&N({token:e}).then((e=>{e&&e.success&&(this.fetchedProfile=e.data,e.data.username&&(this.displayName=e.data.username))})).catch((e=>{console.error("Fetch user profile failed",e)}))},login(){a({url:"/pages/login/index"})},logout(){try{t("user")}catch(e){}this.loggedIn=!1,this.displayName="",this.fetchedProfile={},o({title:"已退出登录",icon:"success"})},onAuthButton(){this.loggedIn?this.logout():this.login()},handleEdit(){this.editForm={username:this.profile.username,company_name:this.profile.companyName,contact_name:this.profile.contactName,region:this.profile.region,phone:this.profile.phone},this.isEditing=!0},handleCancel(){this.isEditing=!1,this.editForm={}},handleSave(){const l=e("user"),a=l&&(l.token||l.data&&l.data.token)||"";a?(s({title:"保存中"}),V({...this.editForm,token:a}).then((e=>{i(),e&&e.success?(o({title:"更新成功",icon:"success"}),this.isEditing=!1,this.fetchedProfile={...this.fetchedProfile,username:this.editForm.username,company_name:this.editForm.company_name,contact_name:this.editForm.contact_name,region:this.editForm.region},this.loadUserProfile(a)):o({title:e.message||"更新失败",icon:"none"})})).catch((e=>{i(),console.error(e),o({title:"更新出错",icon:"none"})}))):o({title:"请先登录",icon:"none"})},openSecurityModal(e){this.securityType=e,this.securityForm={value:"",code:""},this.showSecurityModal=!0},closeSecurityModal(){this.showSecurityModal=!1,this.securityForm={value:"",code:""},this.timer&&(clearInterval(this.timer),this.timer=null),this.countdown=0},sendCode(){if(this.countdown>0)return;const l=e("user"),a=l&&(l.token||l.data&&l.data.token)||"";if(!a)return void o({title:"请先登录",icon:"none"});const t=this.securityForm.value;if("phone"===this.securityType){if(!/^1[3-9]\d{9}$/.test(t))return void o({title:"请输入正确的手机号",icon:"none"})}else if("email"===this.securityType&&!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t))return void o({title:"请输入正确的邮箱",icon:"none"});s({title:"发送中"}),S({token:a}).then((e=>{i(),e&&e.success?(o({title:"已发送至安全邮箱",icon:"none",duration:2e3}),this.countdown=60,this.timer=setInterval((()=>{this.countdown--,this.countdown<=0&&(clearInterval(this.timer),this.timer=null)}),1e3)):o({title:e.message||"发送失败",icon:"none"})})).catch((e=>{i(),console.error(e),o({title:"发送出错",icon:"none"})}))},confirmSecurityEdit(){const{value:l,code:a}=this.securityForm;if(!l)return void o({title:this.securityPlaceholder,icon:"none"});if(!a)return void o({title:"请输入验证码",icon:"none"});const t=e("user"),n=t&&(t.token||t.data&&t.data.token)||"";if(!n)return void o({title:"请先登录",icon:"none"});let c;s({title:"提交中"}),"phone"===this.securityType?c=I({new_phone:l,code:a,token:n}):"email"===this.securityType?c=P({new_email:l,code:a,token:n}):"password"===this.securityType&&(c=Promise.reject({message:"暂无修改密码接口"})),c&&c.then((e=>{i(),e&&e.success?(o({title:"修改成功",icon:"success"}),this.closeSecurityModal(),this.loadUserProfile(n)):o({title:e.message||"修改失败",icon:"none"})})).catch((e=>{i(),console.error(e),o({title:e&&e.message||"修改出错",icon:"none"})}))}}},[["render",function(e,l,a,t,o,s){const i=k,b=v,N=w,V=r,S=F,I=C,P=n("FloatingNav");return u(),c(V,{class:"page"},{default:d((()=>[m(V,{class:"header"},{default:d((()=>[m(i,{class:"avatar",src:E}),m(V,{class:"user"},{default:d((()=>[m(b,{class:"name"},{default:d((()=>[f(h(o.loggedIn?o.displayName:"未登录"),1)])),_:1}),m(N,{size:"mini",class:"login",onClick:s.onAuthButton},{default:d((()=>[f(h(o.loggedIn?"退出登录":"登录"),1)])),_:1},8,["onClick"])])),_:1})])),_:1}),m(V,{class:"info-card"},{default:d((()=>[m(V,{class:"card-header"},{default:d((()=>[m(b,{class:"card-title"},{default:d((()=>[f("个人信息")])),_:1}),o.loggedIn?(u(),c(V,{key:0,class:"card-actions"},{default:d((()=>[o.isEditing?(u(),p(_,{key:1},[m(b,{class:"btn-cancel",onClick:s.handleCancel},{default:d((()=>[f("取消")])),_:1},8,["onClick"]),m(b,{class:"btn-save",onClick:s.handleSave},{default:d((()=>[f("保存")])),_:1},8,["onClick"])],64)):(u(),c(b,{key:0,class:"btn-edit",onClick:s.handleEdit},{default:d((()=>[f("编辑")])),_:1},8,["onClick"]))])),_:1})):y("",!0)])),_:1}),m(V,{class:"info-row"},{default:d((()=>[m(b,{class:"label"},{default:d((()=>[f("用户名")])),_:1}),o.isEditing?(u(),c(S,{key:0,class:"input",modelValue:o.editForm.username,"onUpdate:modelValue":l[0]||(l[0]=e=>o.editForm.username=e),placeholder:"请输入用户名"},null,8,["modelValue"])):(u(),c(b,{key:1,class:"value"},{default:d((()=>[f(h(s.profile.username),1)])),_:1}))])),_:1}),m(V,{class:"info-row"},{default:d((()=>[m(b,{class:"label"},{default:d((()=>[f("手机号")])),_:1}),m(b,{class:"value"},{default:d((()=>[f(h(s.profile.phone),1)])),_:1}),o.loggedIn?(u(),c(b,{key:0,class:"btn-link",onClick:l[1]||(l[1]=e=>s.openSecurityModal("phone"))},{default:d((()=>[f("修改")])),_:1})):y("",!0)])),_:1}),m(V,{class:"info-row"},{default:d((()=>[m(b,{class:"label"},{default:d((()=>[f("邮箱")])),_:1}),m(b,{class:"value"},{default:d((()=>[f(h(s.profile.email),1)])),_:1}),o.loggedIn?(u(),c(b,{key:0,class:"btn-link",onClick:l[2]||(l[2]=e=>s.openSecurityModal("email"))},{default:d((()=>[f("修改")])),_:1})):y("",!0)])),_:1}),m(V,{class:"info-row"},{default:d((()=>[m(b,{class:"label"},{default:d((()=>[f("登录密码")])),_:1}),m(b,{class:"value"},{default:d((()=>[f("********")])),_:1}),o.loggedIn?(u(),c(b,{key:0,class:"btn-link",onClick:l[3]||(l[3]=e=>s.openSecurityModal("password"))},{default:d((()=>[f("修改")])),_:1})):y("",!0)])),_:1}),m(V,{class:"info-row"},{default:d((()=>[m(b,{class:"label"},{default:d((()=>[f("公司名称")])),_:1}),o.isEditing?(u(),c(S,{key:0,class:"input",modelValue:o.editForm.company_name,"onUpdate:modelValue":l[4]||(l[4]=e=>o.editForm.company_name=e),placeholder:"请输入公司名称"},null,8,["modelValue"])):(u(),c(b,{key:1,class:"value"},{default:d((()=>[f(h(s.profile.companyName),1)])),_:1}))])),_:1}),m(V,{class:"info-row"},{default:d((()=>[m(b,{class:"label"},{default:d((()=>[f("联系人")])),_:1}),o.isEditing?(u(),c(S,{key:0,class:"input",modelValue:o.editForm.contact_name,"onUpdate:modelValue":l[5]||(l[5]=e=>o.editForm.contact_name=e),placeholder:"请输入联系人"},null,8,["modelValue"])):(u(),c(b,{key:1,class:"value"},{default:d((()=>[f(h(s.profile.contactName),1)])),_:1}))])),_:1}),m(V,{class:"info-row"},{default:d((()=>[m(b,{class:"label"},{default:d((()=>[f("地区")])),_:1}),o.isEditing?(u(),c(S,{key:0,class:"input",modelValue:o.editForm.region,"onUpdate:modelValue":l[6]||(l[6]=e=>o.editForm.region=e),placeholder:"请输入地区"},null,8,["modelValue"])):(u(),c(b,{key:1,class:"value"},{default:d((()=>[f(h(s.profile.region),1)])),_:1}))])),_:1})])),_:1}),m(V,{class:"menu"},{default:d((()=>[m(I,{url:"/pages/order/index",class:"menu-item"},{default:d((()=>[m(b,null,{default:d((()=>[f("我的订单")])),_:1}),m(b,{class:"arrow"},{default:d((()=>[f("›")])),_:1})])),_:1}),m(I,{url:"/pages/cart/index","open-type":"switchTab",class:"menu-item"},{default:d((()=>[m(b,null,{default:d((()=>[f("我的购物车")])),_:1}),m(b,{class:"arrow"},{default:d((()=>[f("›")])),_:1})])),_:1}),m(I,{url:"/pages/settings/index",class:"menu-item"},{default:d((()=>[m(b,null,{default:d((()=>[f("设置")])),_:1}),m(b,{class:"arrow"},{default:d((()=>[f("›")])),_:1})])),_:1}),m(I,{url:"/pages/messages/index",class:"menu-item"},{default:d((()=>[m(b,null,{default:d((()=>[f("消息")])),_:1}),m(b,{class:"arrow"},{default:d((()=>[f("›")])),_:1})])),_:1}),m(I,{url:"/pages/address/index",class:"menu-item","hover-class":"none"},{default:d((()=>[m(b,null,{default:d((()=>[f("收货地址")])),_:1}),m(b,{class:"arrow"},{default:d((()=>[f("›")])),_:1})])),_:1})])),_:1}),m(P),o.showSecurityModal?(u(),c(V,{key:0,class:"modal-mask",onClick:s.closeSecurityModal},{default:d((()=>[m(V,{class:"modal-content",onClick:l[9]||(l[9]=g((()=>{}),["stop"]))},{default:d((()=>[m(V,{class:"modal-header"},{default:d((()=>[m(b,{class:"modal-title"},{default:d((()=>[f(h(s.securityTitle),1)])),_:1})])),_:1}),m(V,{class:"modal-body"},{default:d((()=>[m(S,{class:"modal-input",modelValue:o.securityForm.value,"onUpdate:modelValue":l[7]||(l[7]=e=>o.securityForm.value=e),placeholder:s.securityPlaceholder},null,8,["modelValue","placeholder"]),m(V,{class:"code-box"},{default:d((()=>[m(S,{class:"modal-input code",modelValue:o.securityForm.code,"onUpdate:modelValue":l[8]||(l[8]=e=>o.securityForm.code=e),placeholder:"请输入验证码"},null,8,["modelValue"]),m(N,{size:"mini",class:"btn-code",disabled:o.countdown>0,onClick:s.sendCode},{default:d((()=>[f(h(o.countdown>0?`${o.countdown}s`:"获取验证码"),1)])),_:1},8,["disabled","onClick"])])),_:1})])),_:1}),m(V,{class:"modal-footer"},{default:d((()=>[m(N,{class:"modal-btn cancel",onClick:s.closeSecurityModal},{default:d((()=>[f("取消")])),_:1},8,["onClick"]),m(N,{class:"modal-btn confirm",onClick:s.confirmSecurityEdit},{default:d((()=>[f("确认")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1},8,["onClick"])):y("",!0)])),_:1})}],["__scopeId","data-v-e912a359"]]);export{M as default};
